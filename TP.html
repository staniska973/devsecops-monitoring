<!DOCTYPE html><html><head>
      <title>TP</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////Users/mac/.vscode/extensions/shd101wyy.markdown-preview-enhanced-0.8.20/crossnote/dependencies/katex/katex.min.css">
      
      
      <script type="text/javascript" src="file:////Users/mac/.vscode/extensions/shd101wyy.markdown-preview-enhanced-0.8.20/crossnote/dependencies/mermaid/mermaid.min.js" charset="UTF-8"></script>
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="tp--devsecops--monitoring">TP — DevSecOps / Monitoring </h1>
<hr>
<h2 id="vue-densemble">Vue d'ensemble </h2>
<div class="mermaid">flowchart LR
    Dev([Développeur]) --&gt;|git push| GH[GitHub]

    subgraph CI ["Pipeline GitHub Actions"]
        direction TB
        A[Build &amp; Test] --&gt; B[Lint Dockerfile Hadolint]
        B --&gt; C[Scan image Trivy]
        C --&gt; D[Analyse code CodeQL]
        D --&gt; E[Push image GHCR]
    end

    GH --&gt; CI

    subgraph Stack ["Stack locale"]
        direction TB
        App[App Node.js :3000] --&gt;|/metrics| Prom[Prometheus :9090]
        Prom --&gt;|PromQL| Graf[Grafana :3001]
    end

    E --&gt;|docker pull| Stack
</div><hr>
<h2 id="partie-1--application-nodejs-15-min">Partie 1 — Application Node.js (15 min) </h2>
<h3 id="11-initialiser-le-projet">1.1 Initialiser le projet </h3>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">mkdir</span> nodeapp-devsecops <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> nodeapp-devsecops
<span class="token function">npm</span> init <span class="token parameter variable">-y</span>
<span class="token function">npm</span> <span class="token function">install</span> express prom-client
</code></pre><h3 id="12-créer-appjs">1.2 Créer <code>app.js</code> </h3>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript javascript"><code><span class="token keyword keyword-const">const</span> express    <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> promClient <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'prom-client'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-const">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> register <span class="token operator">=</span> promClient<span class="token punctuation">.</span><span class="token property-access">register</span><span class="token punctuation">;</span>

<span class="token comment">// Métriques par défaut (CPU, mémoire, event loop)</span>
promClient<span class="token punctuation">.</span><span class="token method function property-access">collectDefaultMetrics</span><span class="token punctuation">(</span><span class="token punctuation">{</span> register <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Counter — requêtes HTTP totales</span>
<span class="token keyword keyword-const">const</span> httpTotal <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">promClient<span class="token punctuation">.</span>Counter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'http_requests_total'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">help</span><span class="token operator">:</span> <span class="token string">'Total requêtes HTTP'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">labelNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'method'</span><span class="token punctuation">,</span> <span class="token string">'route'</span><span class="token punctuation">,</span> <span class="token string">'status'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Histogram — durée des requêtes</span>
<span class="token keyword keyword-const">const</span> httpDuration <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">promClient<span class="token punctuation">.</span>Histogram</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'http_request_duration_seconds'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">help</span><span class="token operator">:</span> <span class="token string">'Durée des requêtes HTTP'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">buckets</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Middleware d'instrumentation</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> end <span class="token operator">=</span> httpDuration<span class="token punctuation">.</span><span class="token method function property-access">startTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'finish'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
    httpTotal<span class="token punctuation">.</span><span class="token method function property-access">inc</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> req<span class="token punctuation">.</span><span class="token property-access">method</span><span class="token punctuation">,</span> <span class="token literal-property property">route</span><span class="token operator">:</span> req<span class="token punctuation">.</span><span class="token property-access">path</span><span class="token punctuation">,</span> <span class="token literal-property property">status</span><span class="token operator">:</span> res<span class="token punctuation">.</span><span class="token property-access">statusCode</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Routes</span>
app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Hello DevSecOps!'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'/health'</span><span class="token punctuation">,</span>  <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">'ok'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'/metrics'</span><span class="token punctuation">,</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> register<span class="token punctuation">.</span><span class="token property-access">contentType</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token keyword control-flow keyword-await">await</span> register<span class="token punctuation">.</span><span class="token method function property-access">metrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'App démarrée sur le port 3000'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="13-tester-en-local">1.3 Tester en local </h3>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">node</span> app.js <span class="token operator">&amp;</span>
<span class="token function">curl</span> http://localhost:3000/
<span class="token function">curl</span> http://localhost:3000/health
<span class="token function">curl</span> http://localhost:3000/metrics   <span class="token comment"># doit afficher les métriques Prometheus</span>
</code></pre><hr>
<h2 id="partie-2--conteneurisation-10-min">Partie 2 — Conteneurisation (10 min) </h2>
<h3 id="21-créer-le-dockerfile">2.1 Créer le <code>Dockerfile</code> </h3>
<pre data-role="codeBlock" data-info="dockerfile" class="language-dockerfile dockerfile"><code><span class="token instruction"><span class="token keyword keyword-FROM">FROM</span> node:20-alpine</span>

<span class="token instruction"><span class="token keyword keyword-WORKDIR">WORKDIR</span> /app</span>

<span class="token instruction"><span class="token keyword keyword-COPY">COPY</span> package*.json ./</span>
<span class="token instruction"><span class="token keyword keyword-RUN">RUN</span> npm ci --only=production</span>

<span class="token instruction"><span class="token keyword keyword-COPY">COPY</span> app.js .</span>

<span class="token instruction"><span class="token keyword keyword-RUN">RUN</span> addgroup -S appgroup &amp;&amp; adduser -S appuser -G appgroup</span>
<span class="token instruction"><span class="token keyword keyword-USER">USER</span> appuser</span>

<span class="token instruction"><span class="token keyword keyword-EXPOSE">EXPOSE</span> 3000</span>
<span class="token instruction"><span class="token keyword keyword-HEALTHCHECK">HEALTHCHECK</span> <span class="token options"><span class="token property">--interval</span><span class="token punctuation">=</span><span class="token string">30s</span> <span class="token property">--timeout</span><span class="token punctuation">=</span><span class="token string">5s</span></span> <span class="token operator">\</span>
  <span class="token keyword keyword-CMD">CMD</span> wget -qO- http://localhost:3000/health || exit 1</span>

<span class="token instruction"><span class="token keyword keyword-CMD">CMD</span> [<span class="token string">"node"</span>, <span class="token string">"app.js"</span>]</span>
</code></pre><h3 id="22-créer-dockerignore">2.2 Créer <code>.dockerignore</code> </h3>
<pre data-role="codeBlock" data-info="" class="language-text"><code>node_modules
.env
*.log
</code></pre><h3 id="23-build-et-test-local">2.3 Build et test local </h3>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">docker</span> build <span class="token parameter variable">-t</span> nodeapp:local <span class="token builtin class-name">.</span>
<span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">3000</span>:3000 <span class="token parameter variable">--name</span> <span class="token builtin class-name">test</span> nodeapp:local
<span class="token function">curl</span> http://localhost:3000/health
<span class="token function">docker</span> stop <span class="token builtin class-name">test</span> <span class="token operator">&amp;&amp;</span> <span class="token function">docker</span> <span class="token function">rm</span> <span class="token builtin class-name">test</span>
</code></pre><hr>
<h2 id="partie-3--pipeline-devsecops-sur-github-20-min">Partie 3 — Pipeline DevSecOps sur GitHub (20 min) </h2>
<h3 id="31-architecture-du-pipeline">3.1 Architecture du pipeline </h3>
<div class="mermaid">flowchart TD
    Push([git push]) --&gt; Trigger

    subgraph Pipeline ["GitHub Actions — CI/CD"]
        Trigger --&gt; Build

        Build["Build node:20-alpine npm ci"] --&gt; Hadolint
        Hadolint["Hadolint Lint Dockerfile"] --&gt; Trivy
        Trivy["Trivy Scan vuln image"] --&gt; CodeQL
        CodeQL["CodeQL Analyse statique JS"] --&gt; Push_GHCR

        Push_GHCR["Push ghcr.io/user/nodeapp"]
    end

    Push_GHCR --&gt; GHCR[("GitHub Container Registry")]

    style Build fill:#1E3A5F,color:#fff
    style Hadolint fill:#E6522C,color:#fff
    style Trivy fill:#E6522C,color:#fff
    style CodeQL fill:#E6522C,color:#fff
    style Push_GHCR fill:#0D9488,color:#fff
</div><h3 id="32-initialiser-le-dépôt-github">3.2 Initialiser le dépôt GitHub </h3>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> init
<span class="token builtin class-name">echo</span> <span class="token string">"node_modules/"</span> <span class="token operator">&gt;</span> .gitignore
<span class="token builtin class-name">echo</span> <span class="token string">".env"</span>         <span class="token operator">&gt;&gt;</span> .gitignore
<span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span>
<span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">"feat: initial Node.js app"</span>
</code></pre><p>Créer le dépôt sur <a href="http://github.com">github.com</a>, puis :</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> remote <span class="token function">add</span> origin https://github.com/VOTRE_USERNAME/nodeapp-devsecops.git
<span class="token function">git</span> push <span class="token parameter variable">-u</span> origin main
</code></pre><h3 id="33-créer-le-workflow">3.3 Créer le workflow </h3>
<p>Créer le fichier <code>.github/workflows/devsecops.yml</code> :</p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">name</span><span class="token punctuation">:</span> DevSecOps Pipeline

<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span>
  <span class="token key atrule">pull_request</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span>

<span class="token key atrule">env</span><span class="token punctuation">:</span>
  <span class="token key atrule">IMAGE_NAME</span><span class="token punctuation">:</span> ghcr.io/$<span class="token punctuation">{</span><span class="token punctuation">{</span> github.repository_owner <span class="token punctuation">}</span><span class="token punctuation">}</span>/nodeapp

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token comment"># ── Job 1 : Build &amp; Tests</span>
  <span class="token key atrule">build</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> Build &amp; Test
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v4

      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v4
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token string">'20'</span>
          <span class="token key atrule">cache</span><span class="token punctuation">:</span> <span class="token string">'npm'</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Installer les dépendances
        <span class="token key atrule">run</span><span class="token punctuation">:</span> npm ci

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Vérifier que l'app démarre
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          node app.js &amp;
          sleep 2
          curl -sf http://localhost:3000/health || exit 1
          kill %1</span>

  <span class="token comment"># ── Job 2 : Lint Dockerfile</span>
  <span class="token key atrule">hadolint</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> Lint Dockerfile
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">needs</span><span class="token punctuation">:</span> build
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v4
      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> hadolint/hadolint<span class="token punctuation">-</span>action@v3.1.0
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile

  <span class="token comment"># ── Job 3 : Build image + Scan Trivy</span>
  <span class="token key atrule">trivy</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> Scan Trivy
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">needs</span><span class="token punctuation">:</span> build
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v4

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build image Docker
        <span class="token key atrule">run</span><span class="token punctuation">:</span> docker build <span class="token punctuation">-</span>t nodeapp<span class="token punctuation">:</span>scan .

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Scan Trivy (CRITICAL + HIGH)
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> aquasecurity/trivy<span class="token punctuation">-</span>action@master
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">image-ref</span><span class="token punctuation">:</span> nodeapp<span class="token punctuation">:</span>scan
          <span class="token key atrule">format</span><span class="token punctuation">:</span> table
          <span class="token key atrule">severity</span><span class="token punctuation">:</span> CRITICAL<span class="token punctuation">,</span>HIGH
          <span class="token key atrule">exit-code</span><span class="token punctuation">:</span> <span class="token string">'1'</span>

  <span class="token comment"># ── Job 4 : Analyse CodeQL</span>
  <span class="token key atrule">codeql</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> Analyse CodeQL
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">needs</span><span class="token punctuation">:</span> build
    <span class="token key atrule">permissions</span><span class="token punctuation">:</span>
      <span class="token key atrule">security-events</span><span class="token punctuation">:</span> write
      <span class="token key atrule">actions</span><span class="token punctuation">:</span> read
      <span class="token key atrule">contents</span><span class="token punctuation">:</span> read
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v4

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Initialiser CodeQL
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> github/codeql<span class="token punctuation">-</span>action/init@v3
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">languages</span><span class="token punctuation">:</span> javascript

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Analyse CodeQL
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> github/codeql<span class="token punctuation">-</span>action/analyze@v3

  <span class="token comment"># ── Job 5 : Push sur GHCR (seulement si tout est vert)</span>
  <span class="token key atrule">publish</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> Publier sur GHCR
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">needs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>hadolint<span class="token punctuation">,</span> trivy<span class="token punctuation">,</span> codeql<span class="token punctuation">]</span>
    <span class="token key atrule">if</span><span class="token punctuation">:</span> github.ref == 'refs/heads/main'
    <span class="token key atrule">permissions</span><span class="token punctuation">:</span>
      <span class="token key atrule">contents</span><span class="token punctuation">:</span> read
      <span class="token key atrule">packages</span><span class="token punctuation">:</span> write
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v4

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Login GHCR
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/login<span class="token punctuation">-</span>action@v3
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">registry</span><span class="token punctuation">:</span> ghcr.io
          <span class="token key atrule">username</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> github.actor <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token key atrule">password</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GITHUB_TOKEN <span class="token punctuation">}</span><span class="token punctuation">}</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Métadonnées image
        <span class="token key atrule">id</span><span class="token punctuation">:</span> meta
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/metadata<span class="token punctuation">-</span>action@v5
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">images</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> env.IMAGE_NAME <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            type=sha,prefix=sha-
            type=raw,value=latest</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build &amp; Push image
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/build<span class="token punctuation">-</span>push<span class="token punctuation">-</span>action@v5
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">context</span><span class="token punctuation">:</span> .
          <span class="token key atrule">push</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">tags</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> steps.meta.outputs.tags <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token key atrule">labels</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> steps.meta.outputs.labels <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre><h3 id="34-committer-et-pousser">3.4 Committer et pousser </h3>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> <span class="token function">add</span> .github/
<span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">"ci: add DevSecOps pipeline"</span>
<span class="token function">git</span> push
</code></pre><p>Vérifier l'exécution dans <strong>GitHub → Actions</strong> (les 5 jobs doivent passer en vert).</p>
<blockquote>
<p><strong>⚠️ Si Trivy échoue</strong> : une vulnérabilité CRITICAL a été détectée dans l'image. Mettre à jour la version de base dans le Dockerfile (<code>node:20-alpine</code> → vérifier la version la plus récente) et repousser.</p>
</blockquote>
<hr>
<h2 id="partie-4--stack-monitoring-15-min">Partie 4 — Stack Monitoring (15 min) </h2>
<h3 id="41-architecture-de-monitoring">4.1 Architecture de monitoring </h3>
<div class="mermaid">flowchart LR
    subgraph App ["Conteneurs Docker"]
        N[App Node.js :3000/metrics]
        NE[Node Exporter :9100/metrics]
    end

    subgraph Monitoring ["Stack Monitoring"]
        P[Prometheus :9090]
        G[Grafana :3001]
    end

    N --&gt;|scrape 15s| P
    NE --&gt;|scrape 15s| P
    P --&gt;|PromQL| G

    G --&gt;|alerte| Slack([Slack / Email])

    style N fill:#1E6BB8,color:#fff
    style NE fill:#1E6BB8,color:#fff
    style P fill:#E6522C,color:#fff
    style G fill:#F46800,color:#fff
</div><h3 id="42-configuration-prometheus">4.2 Configuration Prometheus </h3>
<p>Créer <code>prometheus/prometheus.yml</code> :</p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">global</span><span class="token punctuation">:</span>
  <span class="token key atrule">scrape_interval</span><span class="token punctuation">:</span> 15s

<span class="token key atrule">scrape_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'nodeapp'</span>
    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'app:3000'</span><span class="token punctuation">]</span>

  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'node-exporter'</span>
    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'node-exporter:9100'</span><span class="token punctuation">]</span>
</code></pre><h3 id="43-docker-composeyml">4.3 <code>docker-compose.yml</code> </h3>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">monitoring</span><span class="token punctuation">:</span>           <span class="token comment"># réseau partagé entre tous les conteneurs</span>

<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token key atrule">prometheus_data</span><span class="token punctuation">:</span>      <span class="token comment"># persistance des métriques Prometheus</span>
  <span class="token key atrule">grafana_data</span><span class="token punctuation">:</span>         <span class="token comment"># persistance des dashboards Grafana</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>

  <span class="token comment"># ── 1. Votre application Node.js</span>
  <span class="token key atrule">app</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span> .
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"3000:3000"</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>monitoring<span class="token punctuation">]</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped

  <span class="token comment"># ── 2. Prometheus — collecte et stocke les métriques</span>
  <span class="token key atrule">prometheus</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> prom/prometheus<span class="token punctuation">:</span>v2.48.0
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./prometheus/prometheus.yml<span class="token punctuation">:</span>/etc/prometheus/prometheus.yml<span class="token punctuation">:</span>ro
      <span class="token punctuation">-</span> prometheus_data<span class="token punctuation">:</span>/prometheus
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'--config.file=/etc/prometheus/prometheus.yml'</span>
      <span class="token punctuation">-</span> <span class="token string">'--web.enable-lifecycle'</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"9090:9090"</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>monitoring<span class="token punctuation">]</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped

  <span class="token comment"># ── 3. Grafana — visualisation des métriques</span>
  <span class="token key atrule">grafana</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> grafana/grafana<span class="token punctuation">:</span>10.2.0
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">GF_SECURITY_ADMIN_USER</span><span class="token punctuation">:</span> admin
      <span class="token key atrule">GF_SECURITY_ADMIN_PASSWORD</span><span class="token punctuation">:</span> admin123
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> grafana_data<span class="token punctuation">:</span>/var/lib/grafana
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"3001:3000"</span>       <span class="token comment"># Grafana écoute en interne sur 3000, on expose sur 3001</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>monitoring<span class="token punctuation">]</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>prometheus<span class="token punctuation">]</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped

  <span class="token comment"># ── 4. Node Exporter — métriques système (CPU, RAM, disque...)</span>
  <span class="token key atrule">node-exporter</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> prom/node<span class="token punctuation">-</span>exporter<span class="token punctuation">:</span>v1.7.0
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"9100:9100"</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>monitoring<span class="token punctuation">]</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped
</code></pre><h3 id="44-lancer-la-stack">4.4 Lancer la stack </h3>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">docker</span> compose up <span class="token parameter variable">-d</span> <span class="token parameter variable">--build</span>
</code></pre><p>Vérifier que les 4 conteneurs sont bien démarrés :</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">docker</span> compose <span class="token function">ps</span>
</code></pre><p>Résultat attendu — tous les conteneurs doivent afficher <code>running</code> :</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>NAME             STATUS          PORTS
nodeapp-app      running         0.0.0.0:3000-&gt;3000/tcp
nodeapp-prom     running         0.0.0.0:9090-&gt;9090/tcp
nodeapp-grafana  running         0.0.0.0:3001-&gt;3000/tcp
nodeapp-nodeexp  running         0.0.0.0:9100-&gt;9100/tcp
</code></pre><h3 id="45-vérifier-que-prometheus-scrape-bien-lapp">4.5 Vérifier que Prometheus scrape bien l'app </h3>
<p><strong>Ouvrir</strong> <a href="http://localhost:9090/targets">http://localhost:9090/targets</a> dans le navigateur.</p>
<p>Vous devez voir deux lignes avec le statut <strong><code>UP</code></strong> en vert :</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>nodeapp        http://app:3000/metrics           UP
node-exporter  http://node-exporter:9100/metrics  UP
</code></pre><blockquote>
<p><strong>Si un target est <code>DOWN</code></strong> : vérifier que le service est bien dans le réseau <code>monitoring</code> dans le <code>docker-compose.yml</code> et relancer avec <code>docker compose restart</code>.</p>
</blockquote>
<h3 id="46-explorer-les-métriques-dans-prometheus">4.6 Explorer les métriques dans Prometheus </h3>
<p><strong>Ouvrir</strong> <a href="http://localhost:9090">http://localhost:9090</a></p>
<p>Dans le champ de recherche en haut, taper :</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>http_requests_total
</code></pre><p>Cliquer sur <strong>Execute</strong> → vous voyez les valeurs brutes collectées depuis votre app.</p>
<p>Essayer ensuite une requête calculée :</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>rate(http_requests_total[1m])
</code></pre><p>Cliquer sur l'onglet <strong>Graph</strong> pour voir l'évolution dans le temps.</p>
<blockquote>
<p>Si les valeurs sont à 0 ou vides, envoyer quelques requêtes à l'app d'abord :</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token keyword keyword-for">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword keyword-in">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">seq</span> <span class="token number">1</span> <span class="token number">20</span><span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword keyword-do">do</span> <span class="token function">curl</span> <span class="token parameter variable">-s</span> http://localhost:3000/ <span class="token operator">&gt;</span> /dev/null<span class="token punctuation">;</span> <span class="token function">sleep</span> <span class="token number">0.3</span><span class="token punctuation">;</span> <span class="token keyword keyword-done">done</span>
</code></pre></blockquote>
<hr>
<h2 id="partie-5--dashboard-grafana">Partie 5 — Dashboard Grafana </h2>
<h3 id="51-se-connecter-à-grafana">5.1 Se connecter à Grafana </h3>
<p><strong>Ouvrir</strong> <a href="http://localhost:3001">http://localhost:3001</a></p>
<p>Saisir les identifiants :</p>
<ul>
<li><strong>Username :</strong> <code>admin</code></li>
<li><strong>Password :</strong> <code>admin123</code></li>
</ul>
<p>Grafana demande de changer le mot de passe → cliquer <strong>Skip</strong> pour l'instant.</p>
<h3 id="52-ajouter-prometheus-comme-source-de-données">5.2 Ajouter Prometheus comme source de données </h3>
<p>Grafana ne sait pas encore où se trouve Prometheus. Il faut lui indiquer.</p>
<p><strong>Étape par étape :</strong></p>
<ol>
<li>Dans le menu de gauche, cliquer sur l'icône ⚙️ <strong>Administration</strong> (ou <strong>Connections</strong> selon la version)</li>
<li>Cliquer sur <strong>Data sources</strong></li>
<li>Cliquer sur le bouton bleu <strong>Add data source</strong></li>
<li>Dans la liste, cliquer sur <strong>Prometheus</strong></li>
<li>Dans le champ <strong>Connection → Prometheus server URL</strong>, saisir :<pre data-role="codeBlock" data-info="" class="language-text"><code>http://prometheus:9090
</code></pre><blockquote>
<p>On utilise le nom du service Docker <code>prometheus</code>, pas <code>localhost</code>, car Grafana tourne dans un conteneur et communique via le réseau Docker interne.</p>
</blockquote>
</li>
<li>Laisser tous les autres champs par défaut</li>
<li>Faire défiler vers le bas et cliquer sur <strong>Save &amp; test</strong></li>
<li>Un bandeau vert <strong>✅ Successfully queried the Prometheus API</strong> doit apparaître</li>
</ol>
<h3 id="53-créer-un-nouveau-dashboard">5.3 Créer un nouveau dashboard </h3>
<ol>
<li>Dans le menu de gauche, cliquer sur l'icône 🏠 <strong>Home</strong> → <strong>Dashboards</strong></li>
<li>Cliquer sur le bouton bleu <strong>New</strong> (en haut à droite) → <strong>New dashboard</strong></li>
<li>Cliquer sur <strong>+ Add visualization</strong></li>
<li>Une fenêtre s'ouvre pour choisir la datasource → cliquer sur <strong>Prometheus</strong></li>
</ol>
<p>L'éditeur de panel s'ouvre. Il est composé de :</p>
<ul>
<li><strong>Zone du haut</strong> : aperçu du graphe (vide pour l'instant)</li>
<li><strong>Zone du bas</strong> : éditeur de requête PromQL</li>
<li><strong>Panneau droit</strong> : options de visualisation (type, titre, unités...)</li>
</ul>
<h3 id="54-panel-1--requêtes-par-seconde">5.4 Panel 1 — Requêtes par seconde </h3>
<p><strong>Dans l'éditeur de requête (zone du bas) :</strong></p>
<ol>
<li>Dans le champ <strong>Metrics</strong>, effacer ce qui est écrit et saisir :<pre data-role="codeBlock" data-info="" class="language-text"><code>rate(http_requests_total[1m])
</code></pre></li>
<li>Cliquer sur <strong>Run queries</strong> (ou attendre 1-2 secondes)</li>
<li>Le graphe en haut doit afficher une courbe</li>
</ol>
<p><strong>Configurer le panel (panneau de droite) :</strong></p>
<ol start="4">
<li>Dans le champ <strong>Title</strong> (en haut du panneau droit), écrire : <code>Requêtes par seconde</code></li>
<li>Le type de visualisation <strong>Time series</strong> est déjà sélectionné par défaut → le garder</li>
</ol>
<p><strong>Sauvegarder le panel :</strong></p>
<ol start="6">
<li>Cliquer sur <strong>Apply</strong> (bouton en haut à droite)</li>
</ol>
<h3 id="55-panel-2--taux-derreur-http">5.5 Panel 2 — Taux d'erreur HTTP </h3>
<p>De retour sur le dashboard, cliquer sur <strong>Add</strong> → <strong>Visualization</strong>.</p>
<ol>
<li>Choisir la datasource <strong>Prometheus</strong></li>
<li>Dans le champ <strong>Metrics</strong>, saisir :<pre data-role="codeBlock" data-info="" class="language-text"><code>sum(rate(http_requests_total{status=~"5[0-9][0-9]"}[1m])) / sum(rate(http_requests_total[1m])) * 100
</code></pre></li>
<li>Cliquer <strong>Run queries</strong></li>
</ol>
<p><strong>Configurer le panel :</strong></p>
<ol start="4">
<li>
<p><strong>Title</strong> : <code>Taux d'erreur (%)</code></p>
</li>
<li>
<p>Dans le panneau droit, changer le type de visualisation : cliquer sur <strong>Time series</strong> (en haut du panneau droit) → choisir <strong>Stat</strong></p>
</li>
<li>
<p>Toujours dans le panneau droit, chercher la section <strong>Standard options → Unit</strong> → sélectionner <code>Misc → percent (0-100)</code></p>
</li>
<li>
<p>Chercher la section <strong>Thresholds</strong> :</p>
<ul>
<li>Modifier la valeur <code>80</code> existante en <code>5</code> (rouge au-dessus de 5%)</li>
<li>Cliquer <strong>+ Add threshold</strong> et ajouter <code>1</code> en orange</li>
</ul>
</li>
<li>
<p>Cliquer sur <strong>Apply</strong></p>
</li>
</ol>
<h3 id="56-panel-3--latence-p95">5.6 Panel 3 — Latence p95 </h3>
<p>Cliquer sur <strong>Add</strong> → <strong>Visualization</strong>.</p>
<ol>
<li>Choisir la datasource <strong>Prometheus</strong></li>
<li>Dans le champ <strong>Metrics</strong>, saisir :<pre data-role="codeBlock" data-info="" class="language-text"><code>histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[1m])) by (le)) * 1000
</code></pre></li>
<li>Cliquer <strong>Run queries</strong></li>
</ol>
<p><strong>Configurer le panel :</strong></p>
<ol start="4">
<li><strong>Title</strong> : <code>Latence p95 (ms)</code></li>
<li>Changer le type : <strong>Time series</strong> → <strong>Gauge</strong></li>
<li><strong>Unit</strong> → <code>Time → milliseconds (ms)</code></li>
<li><strong>Thresholds</strong> :
<ul>
<li><code>200</code> en orange (latence acceptable)</li>
<li><code>500</code> en rouge (latence trop élevée)</li>
</ul>
</li>
<li>Cliquer sur <strong>Apply</strong></li>
</ol>
<h3 id="57-sauvegarder-le-dashboard">5.7 Sauvegarder le dashboard </h3>
<ol>
<li>Cliquer sur l'icône 💾 <strong>Save dashboard</strong> (en haut à droite, icône disquette)</li>
<li>Nommer le dashboard : <code>Node.js App — Monitoring</code></li>
<li>Cliquer sur <strong>Save</strong></li>
</ol>
<h3 id="58-générer-du-trafic-et-observer-les-graphes">5.8 Générer du trafic et observer les graphes </h3>
<p>Ouvrir un terminal et lancer :</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Générer des requêtes normales</span>
<span class="token keyword keyword-for">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword keyword-in">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">seq</span> <span class="token number">1</span> <span class="token number">100</span><span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword keyword-do">do</span>
  <span class="token function">curl</span> <span class="token parameter variable">-s</span> http://localhost:3000/ <span class="token operator">&gt;</span> /dev/null
  <span class="token function">curl</span> <span class="token parameter variable">-s</span> http://localhost:3000/health <span class="token operator">&gt;</span> /dev/null
  <span class="token function">sleep</span> <span class="token number">0.2</span>
<span class="token keyword keyword-done">done</span>
</code></pre><p>Retourner dans Grafana et observer les 3 panels se mettre à jour en temps réel.</p>
<blockquote>
<p><strong>Astuce :</strong> Ajuster la fenêtre temporelle en haut à droite du dashboard. Sélectionner <strong>Last 5 minutes</strong> pour voir les données récentes. Activer le <strong>rafraîchissement automatique</strong> en cliquant sur l'icône ⟳ et en choisissant <strong>5s</strong>.</p>
</blockquote>
<h3 id="59-vérifier-les-métriques-système-bonus">5.9 Vérifier les métriques système (bonus) </h3>
<p>Node Exporter expose les métriques de la machine hôte. Pour les voir :</p>
<ol>
<li>Retourner dans <strong>Dashboards → New → Import</strong></li>
<li>Dans le champ <strong>Import via <a href="http://grafana.com">grafana.com</a></strong>, saisir l'ID : <code>1860</code></li>
<li>Cliquer <strong>Load</strong></li>
<li>Sélectionner la datasource <strong>Prometheus</strong> dans le menu déroulant</li>
<li>Cliquer <strong>Import</strong></li>
</ol>
<p>Un dashboard complet avec CPU, RAM, réseau et disque s'importe automatiquement.</p>
<hr>
<h2 id="récapitulatif-des-urls">Récapitulatif des URLs </h2>
<table>
<thead>
<tr>
<th>Service</th>
<th>URL</th>
<th>Credentials</th>
</tr>
</thead>
<tbody>
<tr>
<td>App</td>
<td><a href="http://localhost:3000">http://localhost:3000</a></td>
<td>—</td>
</tr>
<tr>
<td>Métriques app</td>
<td><a href="http://localhost:3000/metrics">http://localhost:3000/metrics</a></td>
<td>—</td>
</tr>
<tr>
<td>Prometheus</td>
<td><a href="http://localhost:9090">http://localhost:9090</a></td>
<td>—</td>
</tr>
<tr>
<td>Grafana</td>
<td><a href="http://localhost:3001">http://localhost:3001</a></td>
<td>admin / admin123</td>
</tr>
</tbody>
</table>
<h2 id="structure-finale-du-projet">Structure finale du projet </h2>
<pre data-role="codeBlock" data-info="" class="language-text"><code>nodeapp-devsecops/
├── .github/
│   └── workflows/
│       └── devsecops.yml
├── prometheus/
│   └── prometheus.yml
├── app.js
├── package.json
├── Dockerfile
├── .dockerignore
└── docker-compose.yml
</code></pre>
      </div>
      
      
    
    
    <script type="module">
// TODO: If ZenUML gets integrated into mermaid in the future,
//      we can remove the following lines.


var MERMAID_CONFIG = ({"startOnLoad":false});
if (typeof MERMAID_CONFIG !== 'undefined') {
  MERMAID_CONFIG.startOnLoad = false
  MERMAID_CONFIG.cloneCssStyles = false
  MERMAID_CONFIG.theme = "default"
}

mermaid.initialize(MERMAID_CONFIG || {})
if (typeof(window['Reveal']) !== 'undefined') {
  function mermaidRevealHelper(event) {
    var currentSlide = event.currentSlide
    var diagrams = currentSlide.querySelectorAll('.mermaid')
    for (var i = 0; i < diagrams.length; i++) {
      var diagram = diagrams[i]
      if (!diagram.hasAttribute('data-processed')) {
        mermaid.init(null, diagram, ()=> {
          Reveal.slide(event.indexh, event.indexv)
        })
      }
    }
  }
  Reveal.addEventListener('slidetransitionend', mermaidRevealHelper)
  Reveal.addEventListener('ready', mermaidRevealHelper)
  await mermaid.run({
    nodes: document.querySelectorAll('.mermaid')
  })
} else {
  await mermaid.run({
    nodes: document.querySelectorAll('.mermaid')
  })
}
</script>
    
    
    
  
    </body></html>